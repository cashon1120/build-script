#!/usr/bin/env node
import e from"fs";import t from"chalk";import o from"inquirer";import r from"terminal-link";import{exec as s,execSync as n}from"child_process";import a from"clipboardy";import i from"ora";const c=()=>{const e=new Date,t="1.0."+e.getFullYear().toString().slice(2)+"."+(e.getMonth()+1).toString().padStart(2,"0")+e.getDate().toString().padStart(2,"0");return{name:`正式环境: ${t}`,value:t}},l="http://47.110.158.152:9000/#/containers",m="https://servervideo.emhes.cn/#!/2/docker/containers",d="/Users/ymhx/Documents/build/build.conf",g="/Users/ymhx/Documents/build/build.Dockerfile",h="/Users/ymhx/Documents/",p={cloud:{label:"运营平台",name:"vrm_cs_new",distPath:`${h}vrm_cs_new/dist/`,imageID:2},cloud_java:{label:"运营平台(JAVA)",name:"vrm_cs_java",distPath:`${h}vrm_cs_new/dist/`,imageID:2,containerURL:m},bjsz:{label:"北京市政",name:"vrm_cs_bjsz",distPath:`${h}vrm_cs_new/dist/`,imageID:2,containerURL:m},chache:{label:"尤恩叉车平台",name:"vrm_cs_new",distPath:`${h}vrm_cs_new/dist/`,imageID:2,containerURL:l},ccScreen:{label:"尤恩叉车大屏",name:"vrm_chachescreen",distPath:`${h}chache_big_screen/dist/`,imageID:2,containerURL:l},wx:{label:"运营公众号",name:"vrm_wx",distPath:`${h}vrm_login/dis`,imageID:2},zsmx:{label:"中升铭行",name:"vrm_new_zsmx",distPath:`${h}vrm_new_zsmx/dist`,containerURL:"http://zsmxweb.emhes.cn:9000/#!/2/docker/containers",imageID:2},ubi:{label:"UBI",name:"vrm_ubi",distPath:`${h}vrm_ubi/dist`,imageID:2},mz:{label:"慕再",name:"vrm_mz",distPath:`${h}vrm_mz/dist`,imageID:2},qtdp:{label:"前台大屏",name:"vrm_reception",distPath:`${h}vrm_big_screen_new/dist`,imageID:2},gcdp:{label:"跟车大屏",name:"vrm_gcscreen",distPath:`${h}follow_screen/dist`,imageID:2}};async function u(o,c){if(!e.existsSync(d))return void console.log(t.red(`🚫 ${d} 目录不存在`));if(!e.existsSync(g))return void console.log(t.red(`🚫 ${g} 目录不存在`));if(!e.existsSync(o.distPath))return void console.log(t.red(`🚫 ${o.distPath} 目录不存在`));console.log(),e.copyFileSync(d,o.distPath+"/build.conf"),console.log(t.blue(`✅ 拷贝 build.conf 至 ${o.distPath}`));const l=`harbor.emhes.cn:1080/platform/${o.name}:${c}`,m=`docker build -f ${g} -t ${l} ${o.distPath}`;let h=i(t.gray(`${m}`)).start();const p=s(m);p&&p.stdout&&p.stderr&&p.on("close",(function(){h.stop(),console.log(t.blue(`✅ ${m}`));const e=`docker push ${l}`;h=i(t.gray(`${e}`)).start(),n(e),h.stop(),console.log(t.blue(`✅ ${e}`));const s=`docker rmi ${l}`;h=i(t.gray(`${s}`)).start(),n(s),h.stop(),console.log(t.blue(`✅ ${s}`));const d=r("查看镜像",`https://harbor.emhes.cn:1080/harbor/projects/${o.imageID}/repositories/${o.name}`),g=o.containerURL||"https://serverweb.emhes.cn/#/containers",p=r("发布[正式]版本",g),u=r("发布[测试]版本","http://192.168.70.2:9000/#!/2/docker/containers");console.log(),console.log(t.greenBright(`👌 Docker镜像推送成功: ${o.label}`),t.greenBright(`${o.name}:`),t.underline(t.greenBright(c)),"dev"!==c?t.gray("(已复制)"):""),console.log(),console.log(t.gray("👉 更多操作:"),t.cyanBright(p),t.yellowBright(u),t.blueBright(d)),"dev"!==c&&a.writeSync(c),console.log()}))}!function(){let e="",r={},s=0,n=1;const a=process.argv.splice(2);if(a[0]){let e=!1;Object.keys(p).map(((t,o)=>{t===a[0]&&(e=!0,s=o)})),e||console.log(t.gray("👻 没找到"),t.yellow(`{${a[0]}}`),t.gray("这个项目, 请从下方选择打包项目⬇️"))}"dev"===a[1]&&(n=0),console.log(t.yellow("🔰 打包前请确认docker已启动!")),console.log(),o.prompt([{type:"rawlist",name:"projectName",message:"打包项目",default:s,choices:Object.keys(p).map((e=>({key:e,name:p[e].label,value:e})))},{type:"rawlist",name:"versionName",message:"打包版本",default:n,choices:[{name:"测试环境: dev",value:"dev"},c(),"自定义"]}]).then((s=>{r=p[s.projectName];const n=s.versionName;if("自定义"!==n)return e=n,void u(r,e);o.prompt([{type:"input",name:"inputVersion",message:"请输入版本号(如: 1.0.xx.xxxx)",validate:e=>4===e.split(".").length||t.red("🚫 版本号格式不正确, 正确格式为: x.x.xx.xxxx")}]).then((t=>{const{inputVersion:o}=t;e=o,u(r,e)}))}))}();
