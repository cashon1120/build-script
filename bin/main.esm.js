#!/usr/bin/env node
import e from"fs";import o from"chalk";import t from"inquirer";import r from"terminal-link";import{exec as a,execSync as n}from"child_process";import s from"clipboardy";import c from"ora";const i=()=>{const e=new Date,o="1.0."+e.getFullYear().toString().slice(2)+"."+(e.getMonth()+1).toString().padStart(2,"0")+e.getDate().toString().padStart(2,"0");return{name:`æ­£å¼çŽ¯å¢ƒ: ${o}`,value:o}},d="http://192.168.70.2:9000/#!/2/docker/containers",l="https://serverweb.emhes.cn/#/containers",m="/Users/ymhx/Documents/build/build.conf",b="/Users/ymhx/Documents/build/build.Dockerfile",f={cloud:{label:"è¿è¥å¹³å°",name:"vrm_cs_new",distPath:"/Users/ymhx/Documents/vrm_cs_new/dist/",imageID:2,containerID:{dev:"ce0d89adc73b5d7a6b01a74722698106b2ec980ff1e87184de02394ae7c433be",prod:"1bde2cd986c54b58fe84d58f40c380b7afa4f5a02495e25e934582376dea78ce"}},wx:{label:"è¿è¥å…¬ä¼—å·",name:"vrm_wx",distPath:"/Users/ymhx/Documents/vrm_login/dist",imageID:2,containerID:{dev:"",prod:"901aa887210e83dbe25305e5764ab3514dd7ec8a9ec6a6216d2f0cb92169bd7b"}},zsmx:{label:"ä¸­å‡é“­è¡Œ",name:"vrm_new_zsmx",distPath:"/Users/ymhx/Documents/vrm_new_zsmx/dist",imageID:2,containerID:{dev:"b1b3f7a5c4ef656291b92081afda74d2f3887e3e722504cab1dcb6d827f74749",prod:"2cdac7e4d29d2932d5d876cef04a738cd81c62ff6585479539a24e98932d444f"}},ubi:{label:"UBI",name:"vrm_ubi",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2,containerID:{dev:"",prod:"414c1543b3501397ff482a2559298b0bc999dcf7a3d9b3b3533edd102c7dd331"}},mz:{label:"æ…•å†",name:"vrm_mz",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2,containerID:{dev:"f8775986acf3f71d605e9c6e9a478c1c1974f4ecfd9874b7782ce1aafbc61e7b",prod:""}},qtdp:{label:"å‰å°å¤§å±",name:"vrm_reception",distPath:"/Users/ymhx/Documents/vrm_big_screen_new/dist",imageID:2,containerID:{dev:"",prod:"28c0d09e8ef926ddab9aaa9a5ae252383ff847050c9f8296c9f769ed38f04f86"}}};async function g(t,i){if(!e.existsSync(m))return void console.log(o.red(`ðŸš« ${m} ç›®å½•ä¸å­˜åœ¨`));if(!e.existsSync(b))return void console.log(o.red(`ðŸš« ${b} ç›®å½•ä¸å­˜åœ¨`));if(!e.existsSync(t.distPath))return void console.log(o.red(`ðŸš« ${t.distPath} ç›®å½•ä¸å­˜åœ¨`));console.log(),e.copyFileSync(m,t.distPath+"/build.conf"),console.log(o.blue(`âœ… æ‹·è´ build.conf è‡³ ${t.distPath}`));const f=`harbor.emhes.cn:1080/platform/${t.name}:${i}`,g=`docker build -f ${b} -t ${f} ${t.distPath}`;let p=c(o.gray(`${g}`)).start();const u=a(g);u&&u.stdout&&u.stderr&&u.on("close",(function(){p.stop(),console.log(o.blue(`âœ… ${g}`));const e=`docker push ${f}`;p=c(o.gray(`${e}`)).start(),n(e),p.stop(),console.log(o.blue(`âœ… ${e}`));const a=`docker rmi ${f}`;p=c(o.gray(`${a}`)).start(),n(a),p.stop(),console.log(o.blue(`âœ… ${a}`));const m=r("æŸ¥çœ‹é•œåƒ",`https://harbor.emhes.cn:1080/harbor/projects/${t.imageID}/repositories/${t.name}`),b=r("å‘å¸ƒç‰ˆæœ¬(æ­£å¼)",t.containerID.prod?`${l}/new?from=${t.containerID.prod}`:l),u=r("å‘å¸ƒç‰ˆæœ¬(æµ‹è¯•)",t.containerID.dev?`${d}/new?from=${t.containerID.dev}`:d);console.log(),console.log(o.greenBright(`ðŸ‘Œ Dockeré•œåƒæŽ¨é€æˆåŠŸ: ${t.label}`),o.greenBright(`${t.name}:`),o.underline(o.greenBright(i)),"dev"!==i?o.gray("(å·²å¤åˆ¶)"):""),console.log(),console.log(o.gray("ðŸ‘‰ æ›´å¤šæ“ä½œ:"),o.blueBright(m),o.blueBright(u),o.blueBright(b)),"dev"!==i&&s.writeSync(i),console.log()}))}!function(){let e="",r={},a=0,n=1;const s=process.argv.splice(2);if(s[0]){let e=!1;Object.keys(f).map(((o,t)=>{o===s[0]&&(e=!0,a=t)})),e||console.log(o.gray("ðŸ‘» æ²¡æ‰¾åˆ°"),o.yellow(`{${s[0]}}`),o.gray("è¿™ä¸ªé¡¹ç›®, è¯·ä»Žä¸‹æ–¹é€‰æ‹©æ‰“åŒ…é¡¹ç›®â¬‡ï¸"))}"dev"===s[1]&&(n=0),t.prompt([{type:"rawlist",name:"projectName",message:"æ‰“åŒ…é¡¹ç›®",default:a,choices:Object.keys(f).map((e=>({key:e,name:f[e].label,value:e})))},{type:"rawlist",name:"versionName",message:"æ‰“åŒ…ç‰ˆæœ¬",default:n,choices:[{name:"æµ‹è¯•çŽ¯å¢ƒ: dev",value:"dev"},i(),"è‡ªå®šä¹‰"]}]).then((a=>{r=f[a.projectName];const n=a.versionName;if("è‡ªå®šä¹‰"!==n)return e=n,void g(r,e);t.prompt([{type:"input",name:"inputVersion",message:"è¯·è¾“å…¥ç‰ˆæœ¬å·(å¦‚: 1.0.xx.xxxx)",validate:e=>4===e.split(".").length||o.red("ðŸš« ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®, æ­£ç¡®æ ¼å¼ä¸º: x.x.xx.xxxx")}]).then((o=>{const{inputVersion:t}=o;e=t,g(r,e)}))}))}();
