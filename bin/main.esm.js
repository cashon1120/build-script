#!/usr/bin/env node
import e from"fs";import o from"chalk";import t from"inquirer";import r from"terminal-link";import{exec as n,execSync as a}from"child_process";import c from"clipboardy";const s=()=>{const e=new Date,o="1.0."+e.getFullYear().toString().slice(2)+"."+(e.getMonth()+1).toString().padStart(2,"0")+e.getDate().toString().padStart(2,"0");return{name:`正式环境: ${o}`,value:o}},i="http://192.168.70.2:9000/#!/2/docker/containers",d="https://serverweb.emhes.cn/#/containers",m="/Users/ymhx/Documents/build/build.conf",l="/Users/ymhx/Documents/build/build.Dockerfile",b={cloud:{label:"运营平台",name:"vrm_cs_new",distPath:"/Users/ymhx/Documents/vrm_cs_new/dist/",imageID:2,containerID:{dev:"ce0d89adc73b5d7a6b01a74722698106b2ec980ff1e87184de02394ae7c433be",prod:"1bde2cd986c54b58fe84d58f40c380b7afa4f5a02495e25e934582376dea78ce"}},wx:{label:"运营公众号",name:"vrm_wx",distPath:"/Users/ymhx/Documents/vrm_login/dist",imageID:2,containerID:{dev:"",prod:"901aa887210e83dbe25305e5764ab3514dd7ec8a9ec6a6216d2f0cb92169bd7b"}},zsmx:{label:"中升铭行",name:"vrm_new_zsmx",distPath:"/Users/ymhx/Documents/vrm_new_zsmx/dist",imageID:2,containerID:{dev:"1421bcb7f14f8fdafef1f81d278ef7be2892a728b92175e7f2b2b9ad241e6f0b",prod:"2cdac7e4d29d2932d5d876cef04a738cd81c62ff6585479539a24e98932d444f"}},ubi:{label:"UBI",name:"vrm_ubi",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2,containerID:{dev:"",prod:"414c1543b3501397ff482a2559298b0bc999dcf7a3d9b3b3533edd102c7dd331"}},mz:{label:"慕再",name:"vrm_mz",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2,containerID:{dev:"f8775986acf3f71d605e9c6e9a478c1c1974f4ecfd9874b7782ce1aafbc61e7b",prod:""}},qtdp:{label:"前台大屏",name:"vrm_reception",distPath:"/Users/ymhx/Documents/vrm_big_screen_new/dist",imageID:2,containerID:{dev:"",prod:"28c0d09e8ef926ddab9aaa9a5ae252383ff847050c9f8296c9f769ed38f04f86"}}};async function f(t,s){if(!e.existsSync(m))return void console.log(o.red(`🚫 ${m} 目录不存在`));if(!e.existsSync(l))return void console.log(o.red(`🚫 ${l} 目录不存在`));if(!e.existsSync(t.distPath))return void console.log(o.red(`🚫 ${t.distPath} 目录不存在`));console.log(o.gray("开始执行docker命令...")),e.copyFileSync(m,t.distPath+"/build.conf"),console.log(o.blue(`拷贝 build.conf 至 ${t.distPath}`));const b=`docker build -f ${l} -t emhes/${t.name}:${s} ${t.distPath}`;console.log(o.blue(`执行 ${b}`));const f=n(b);f&&f.stdout&&f.stderr&&f.on("close",(function(e){const n=`docker tag emhes/${t.name}:${s} harbor.emhes.cn:1080/platform/${t.name}:${s}`;console.log(o.blue(`执行 ${n}`)),a(n);const m=`docker push harbor.emhes.cn:1080/platform/${t.name}:${s}`;console.log(o.blue(`执行 ${m}`)),a(m);const l=r("查看镜像",`https://harbor.emhes.cn:1080/harbor/projects/${t.imageID}/repositories/${t.name}`),b=r("发布版本(正式)",t.containerID.prod?`${d}/new?from=${t.containerID.prod}`:d),f=r("发布版本(测试)",t.containerID.dev?`${i}/new?from=${t.containerID.dev}`:i);console.log(o.greenBright(`👌 操作成功: ${t.label}`),o.greenBright(`${t.name}:`),o.underline(o.greenBright(s)),"dev"!==s?o.gray("(已复制)"):""),console.log(),console.log(o.gray("👉 更多操作:"),o.blueBright(l),o.blueBright(f),o.blueBright(b)),"dev"!==s&&c.writeSync(s),console.log()}))}!function(){let e="",r={},n=0,a=1;const c=process.argv.splice(2);if(c[0]){let e=!1;Object.keys(b).map(((o,t)=>{o===c[0]&&(e=!0,n=t)})),e||console.log(o.gray("👻 没找到"),o.yellow(`{${c[0]}}`),o.gray("这个项目, 请从下方选择打包项目⬇️"))}"dev"===c[1]&&(a=0),t.prompt([{type:"rawlist",name:"projectName",message:"打包项目",default:n,choices:Object.keys(b).map((e=>({key:e,name:b[e].label,value:e})))},{type:"rawlist",name:"versionName",message:"打包版本",default:a,choices:[{name:"测试环境: dev",value:"dev"},s(),"自定义"]}]).then((n=>{r=b[n.projectName];const a=n.versionName;if("自定义"!==a)return e=a,void f(r,e);t.prompt([{type:"input",name:"inputVersion",message:"请输入版本号(如: 1.0.xx.xxxx)",validate:e=>4===e.split(".").length||o.red("🚫 版本号格式不正确, 正确格式为: x.x.xx.xxxx")}]).then((o=>{const{inputVersion:t}=o;e=t,f(r,e)}))}))}();
