#!/usr/bin/env node
import e from"fs";import t from"chalk";import s from"inquirer";import o from"terminal-link";import{exec as r,execSync as n}from"child_process";import i from"clipboardy";import a from"ora";const c=()=>{const e=new Date,t="1.0."+e.getFullYear().toString().slice(2)+"."+(e.getMonth()+1).toString().padStart(2,"0")+e.getDate().toString().padStart(2,"0");return{name:`æ­£å¼çŽ¯å¢ƒ: ${t}`,value:t}},m="http://47.110.158.152:9000/#/containers",l="/Users/ymhx/Documents/build/build.conf",d="/Users/ymhx/Documents/build/build.Dockerfile",h={cloud:{label:"è¿è¥å¹³å°",name:"vrm_cs_new",distPath:"/Users/ymhx/Documents/vrm_cs_new/dist/",imageID:2},cloud_java:{label:"è¿è¥å¹³å°(JAVA)",name:"vrm_cs_java",distPath:"/Users/ymhx/Documents/vrm_cs_new/dist/",imageID:2,containerURL:"https://servervideo.emhes.cn/#!/2/docker/containers"},chache:{label:"å°¤æ©å‰è½¦å¹³å°",name:"vrm_cs_new",distPath:"/Users/ymhx/Documents/vrm_cs_new/dist/",imageID:2,containerURL:m},ccScreen:{label:"å°¤æ©å‰è½¦å¤§å±",name:"vrm_chachescreen",distPath:"/Users/ymhx/Documents/chache_big_screen/dist/",imageID:2,containerURL:m},wx:{label:"è¿è¥å…¬ä¼—å·",name:"vrm_wx",distPath:"/Users/ymhx/Documents/vrm_login/dist",imageID:2},zsmx:{label:"ä¸­å‡é“­è¡Œ",name:"vrm_new_zsmx",distPath:"/Users/ymhx/Documents/vrm_new_zsmx/dist",containerURL:"http://zsmxweb.emhes.cn:9000/#!/2/docker/containers",imageID:2},ubi:{label:"UBI",name:"vrm_ubi",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2},mz:{label:"æ…•å†",name:"vrm_mz",distPath:"/Users/ymhx/Documents/vrm_mz/dist",imageID:2},qtdp:{label:"å‰å°å¤§å±",name:"vrm_reception",distPath:"/Users/ymhx/Documents/vrm_big_screen_new/dist",imageID:2}};async function g(s,c){if(!e.existsSync(l))return void console.log(t.red(`ðŸš« ${l} ç›®å½•ä¸å­˜åœ¨`));if(!e.existsSync(d))return void console.log(t.red(`ðŸš« ${d} ç›®å½•ä¸å­˜åœ¨`));if(!e.existsSync(s.distPath))return void console.log(t.red(`ðŸš« ${s.distPath} ç›®å½•ä¸å­˜åœ¨`));console.log(),e.copyFileSync(l,s.distPath+"/build.conf"),console.log(t.blue(`âœ… æ‹·è´ build.conf è‡³ ${s.distPath}`));const m=`harbor.emhes.cn:1080/platform/${s.name}:${c}`,h=`docker build -f ${d} -t ${m} ${s.distPath}`;let g=a(t.gray(`${h}`)).start();const u=r(h);u&&u.stdout&&u.stderr&&u.on("close",(function(){g.stop(),console.log(t.blue(`âœ… ${h}`));const e=`docker push ${m}`;g=a(t.gray(`${e}`)).start(),n(e),g.stop(),console.log(t.blue(`âœ… ${e}`));const r=`docker rmi ${m}`;g=a(t.gray(`${r}`)).start(),n(r),g.stop(),console.log(t.blue(`âœ… ${r}`));const l=o("æŸ¥çœ‹é•œåƒ",`https://harbor.emhes.cn:1080/harbor/projects/${s.imageID}/repositories/${s.name}`),d=s.containerURL||"https://serverweb.emhes.cn/#/containers",u=o("å‘å¸ƒ[æ­£å¼]ç‰ˆæœ¬",d),p=o("å‘å¸ƒ[æµ‹è¯•]ç‰ˆæœ¬","http://192.168.70.2:9000/#!/2/docker/containers");console.log(),console.log(t.greenBright(`ðŸ‘Œ Dockeré•œåƒæŽ¨é€æˆåŠŸ: ${s.label}`),t.greenBright(`${s.name}:`),t.underline(t.greenBright(c)),"dev"!==c?t.gray("(å·²å¤åˆ¶)"):""),console.log(),console.log(t.gray("ðŸ‘‰ æ›´å¤šæ“ä½œ:"),t.cyanBright(u),t.yellowBright(p),t.blueBright(l)),"dev"!==c&&i.writeSync(c),console.log()}))}!function(){let e="",o={},r=0,n=1;const i=process.argv.splice(2);if(i[0]){let e=!1;Object.keys(h).map(((t,s)=>{t===i[0]&&(e=!0,r=s)})),e||console.log(t.gray("ðŸ‘» æ²¡æ‰¾åˆ°"),t.yellow(`{${i[0]}}`),t.gray("è¿™ä¸ªé¡¹ç›®, è¯·ä»Žä¸‹æ–¹é€‰æ‹©æ‰“åŒ…é¡¹ç›®â¬‡ï¸"))}"dev"===i[1]&&(n=0),console.log(t.yellow("ðŸ”° æ‰“åŒ…å‰è¯·ç¡®è®¤dockerå·²å¯åŠ¨!")),console.log(),s.prompt([{type:"rawlist",name:"projectName",message:"æ‰“åŒ…é¡¹ç›®",default:r,choices:Object.keys(h).map((e=>({key:e,name:h[e].label,value:e})))},{type:"rawlist",name:"versionName",message:"æ‰“åŒ…ç‰ˆæœ¬",default:n,choices:[{name:"æµ‹è¯•çŽ¯å¢ƒ: dev",value:"dev"},c(),"è‡ªå®šä¹‰"]}]).then((r=>{o=h[r.projectName];const n=r.versionName;if("è‡ªå®šä¹‰"!==n)return e=n,void g(o,e);s.prompt([{type:"input",name:"inputVersion",message:"è¯·è¾“å…¥ç‰ˆæœ¬å·(å¦‚: 1.0.xx.xxxx)",validate:e=>4===e.split(".").length||t.red("ðŸš« ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®, æ­£ç¡®æ ¼å¼ä¸º: x.x.xx.xxxx")}]).then((t=>{const{inputVersion:s}=t;e=s,g(o,e)}))}))}();
