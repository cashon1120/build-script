#!/usr/bin/env node
import e from"fs";import o from"chalk";import t from"inquirer";import r from"terminal-link";import{exec as n,execSync as a}from"child_process";import c from"clipboardy";const s=()=>{const e=new Date,o="1.0."+e.getFullYear().toString().slice(2)+"."+(e.getMonth()+1).toString().padStart(2,"0")+e.getDate().toString().padStart(2,"0");return{name:`æ­£å¼çŽ¯å¢ƒ: ${o}`,value:o}},i="http://192.168.70.2:9000/#!/2/docker/containers",d="https://serverweb.emhes.cn/#/containers",m="/Users/ymhx/Documents/build/build.conf",l="/Users/ymhx/Documents/build/build.Dockerfile",b={cloud:{label:"è¿è¥å¹³å°",name:"vrm_cs_new",distPath:"/Users/ymhx/Documents/vrm_cs_new/dist/",imageID:2,containerID:{dev:"ce0d89adc73b5d7a6b01a74722698106b2ec980ff1e87184de02394ae7c433be",prod:"1bde2cd986c54b58fe84d58f40c380b7afa4f5a02495e25e934582376dea78ce"}},wx:{label:"è¿è¥å…¬ä¼—å·",name:"vrm_wx",distPath:"/Users/ymhx/Documents/vrm_login/dist",imageID:2,containerID:{dev:"",prod:"901aa887210e83dbe25305e5764ab3514dd7ec8a9ec6a6216d2f0cb92169bd7b"}},zsmx:{label:"ä¸­å‡é“­è¡Œ",name:"vrm_new_zsmx",distPath:"/Users/ymhx/Documents/vrm_new_zsmx/dist",imageID:2,containerID:{dev:"1421bcb7f14f8fdafef1f81d278ef7be2892a728b92175e7f2b2b9ad241e6f0b",prod:"2cdac7e4d29d2932d5d876cef04a738cd81c62ff6585479539a24e98932d444f"}},ubi:{label:"UBI",name:"vrm_ubi",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2,containerID:{dev:"",prod:"414c1543b3501397ff482a2559298b0bc999dcf7a3d9b3b3533edd102c7dd331"}},mz:{label:"æ…•å†",name:"vrm_mz",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2,containerID:{dev:"f8775986acf3f71d605e9c6e9a478c1c1974f4ecfd9874b7782ce1aafbc61e7b",prod:""}},qtdp:{label:"å‰å°å¤§å±",name:"vrm_reception",distPath:"/Users/ymhx/Documents/vrm_big_screen_new/dist",imageID:2,containerID:{dev:"",prod:"28c0d09e8ef926ddab9aaa9a5ae252383ff847050c9f8296c9f769ed38f04f86"}}};async function f(t,s){if(!e.existsSync(m))return void console.log(o.red(`ðŸš« ${m} ç›®å½•ä¸å­˜åœ¨`));if(!e.existsSync(l))return void console.log(o.red(`ðŸš« ${l} ç›®å½•ä¸å­˜åœ¨`));if(!e.existsSync(t.distPath))return void console.log(o.red(`ðŸš« ${t.distPath} ç›®å½•ä¸å­˜åœ¨`));console.log(o.gray("å¼€å§‹æ‰§è¡Œdockerå‘½ä»¤...")),e.copyFileSync(m,t.distPath+"/build.conf"),console.log(o.blue(`æ‹·è´ build.conf è‡³ ${t.distPath}`));const b=`docker build -f ${l} -t emhes/${t.name}:${s} ${t.distPath}`;console.log(o.blue(`æ‰§è¡Œ ${b}`));const f=n(b);f&&f.stdout&&f.stderr&&f.on("close",(function(e){const n=`docker tag emhes/${t.name}:${s} harbor.emhes.cn:1080/platform/${t.name}:${s}`;console.log(o.blue(`æ‰§è¡Œ ${n}`)),a(n);const m=`docker push harbor.emhes.cn:1080/platform/${t.name}:${s}`;console.log(o.blue(`æ‰§è¡Œ ${m}`)),a(m);const l=r("æŸ¥çœ‹é•œåƒ",`https://harbor.emhes.cn:1080/harbor/projects/${t.imageID}/repositories/${t.name}`),b=r("å‘å¸ƒç‰ˆæœ¬(æ­£å¼)",t.containerID.prod?`${d}/new?from=${t.containerID.prod}`:d),f=r("å‘å¸ƒç‰ˆæœ¬(æµ‹è¯•)",t.containerID.dev?`${i}/new?from=${t.containerID.dev}`:i);console.log(o.greenBright(`ðŸ‘Œ æ“ä½œæˆåŠŸ: ${t.label}`),o.greenBright(`${t.name}:`),o.underline(o.greenBright(s)),"dev"!==s?o.gray("(å·²å¤åˆ¶)"):""),console.log(),console.log(o.gray("ðŸ‘‰ æ›´å¤šæ“ä½œ:"),o.blueBright(l),o.blueBright(f),o.blueBright(b)),"dev"!==s&&c.writeSync(s),console.log()}))}!function(){let e="",r={},n=0,a=1;const c=process.argv.splice(2);if(c[0]){let e=!1;Object.keys(b).map(((o,t)=>{o===c[0]&&(e=!0,n=t)})),e||console.log(o.gray("ðŸ‘» æ²¡æ‰¾åˆ°"),o.yellow(`{${c[0]}}`),o.gray("è¿™ä¸ªé¡¹ç›®, è¯·ä»Žä¸‹æ–¹é€‰æ‹©æ‰“åŒ…é¡¹ç›®â¬‡ï¸"))}"dev"===c[1]&&(a=0),t.prompt([{type:"rawlist",name:"projectName",message:"æ‰“åŒ…é¡¹ç›®",default:n,choices:Object.keys(b).map((e=>({key:e,name:b[e].label,value:e})))},{type:"rawlist",name:"versionName",message:"æ‰“åŒ…ç‰ˆæœ¬",default:a,choices:[{name:"æµ‹è¯•çŽ¯å¢ƒ: dev",value:"dev"},s(),"è‡ªå®šä¹‰"]}]).then((n=>{r=b[n.projectName];const a=n.versionName;if("è‡ªå®šä¹‰"!==a)return e=a,void f(r,e);t.prompt([{type:"input",name:"inputVersion",message:"è¯·è¾“å…¥ç‰ˆæœ¬å·(å¦‚: 1.0.xx.xxxx)",validate:e=>4===e.split(".").length||o.red("ðŸš« ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®, æ­£ç¡®æ ¼å¼ä¸º: x.x.xx.xxxx")}]).then((o=>{const{inputVersion:t}=o;e=t,f(r,e)}))}))}();
