#!/usr/bin/env node
import e from"fs";import o from"chalk";import t from"inquirer";import r from"terminal-link";import{exec as a,execSync as n}from"child_process";import s from"clipboardy";import c from"ora";const i=()=>{const e=new Date,o="1.0."+e.getFullYear().toString().slice(2)+"."+(e.getMonth()+1).toString().padStart(2,"0")+e.getDate().toString().padStart(2,"0");return{name:`正式环境: ${o}`,value:o}},d="http://192.168.70.2:9000/#!/2/docker/containers",l="https://serverweb.emhes.cn/#/containers",m="/Users/ymhx/Documents/build/build.conf",b="/Users/ymhx/Documents/build/build.Dockerfile",f={cloud:{label:"运营平台",name:"vrm_cs_new",distPath:"/Users/ymhx/Documents/vrm_cs_new/dist/",imageID:2,containerID:{dev:"ce0d89adc73b5d7a6b01a74722698106b2ec980ff1e87184de02394ae7c433be",prod:"1bde2cd986c54b58fe84d58f40c380b7afa4f5a02495e25e934582376dea78ce"}},wx:{label:"运营公众号",name:"vrm_wx",distPath:"/Users/ymhx/Documents/vrm_login/dist",imageID:2,containerID:{dev:"",prod:"901aa887210e83dbe25305e5764ab3514dd7ec8a9ec6a6216d2f0cb92169bd7b"}},zsmx:{label:"中升铭行",name:"vrm_new_zsmx",distPath:"/Users/ymhx/Documents/vrm_new_zsmx/dist",imageID:2,containerID:{dev:"b1b3f7a5c4ef656291b92081afda74d2f3887e3e722504cab1dcb6d827f74749",prod:"2cdac7e4d29d2932d5d876cef04a738cd81c62ff6585479539a24e98932d444f"}},ubi:{label:"UBI",name:"vrm_ubi",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2,containerID:{dev:"",prod:"414c1543b3501397ff482a2559298b0bc999dcf7a3d9b3b3533edd102c7dd331"}},mz:{label:"慕再",name:"vrm_mz",distPath:"/Users/ymhx/Documents/vrm_ubi/dist",imageID:2,containerID:{dev:"f8775986acf3f71d605e9c6e9a478c1c1974f4ecfd9874b7782ce1aafbc61e7b",prod:""}},qtdp:{label:"前台大屏",name:"vrm_reception",distPath:"/Users/ymhx/Documents/vrm_big_screen_new/dist",imageID:2,containerID:{dev:"",prod:"28c0d09e8ef926ddab9aaa9a5ae252383ff847050c9f8296c9f769ed38f04f86"}}};async function g(t,i){if(!e.existsSync(m))return void console.log(o.red(`🚫 ${m} 目录不存在`));if(!e.existsSync(b))return void console.log(o.red(`🚫 ${b} 目录不存在`));if(!e.existsSync(t.distPath))return void console.log(o.red(`🚫 ${t.distPath} 目录不存在`));console.log(),e.copyFileSync(m,t.distPath+"/build.conf"),console.log(o.blue(`✅ 拷贝 build.conf 至 ${t.distPath}`));const f=`harbor.emhes.cn:1080/platform/${t.name}:${i}`,g=`docker build -f ${b} -t ${f} ${t.distPath}`;let p=c(o.gray(`${g}`)).start();const u=a(g);u&&u.stdout&&u.stderr&&u.on("close",(function(){p.stop(),console.log(o.blue(`✅ ${g}`));const e=`docker push ${f}`;p=c(o.gray(`${e}`)).start(),n(e),p.stop(),console.log(o.blue(`✅ ${e}`));const a=`docker rmi ${f}`;p=c(o.gray(`${a}`)).start(),n(a),p.stop(),console.log(o.blue(`✅ ${a}`));const m=r("查看镜像",`https://harbor.emhes.cn:1080/harbor/projects/${t.imageID}/repositories/${t.name}`),b=r("发布版本(正式)",t.containerID.prod?`${l}/new?from=${t.containerID.prod}`:l),u=r("发布版本(测试)",t.containerID.dev?`${d}/new?from=${t.containerID.dev}`:d);console.log(),console.log(o.greenBright(`👌 Docker镜像推送成功: ${t.label}`),o.greenBright(`${t.name}:`),o.underline(o.greenBright(i)),"dev"!==i?o.gray("(已复制)"):""),console.log(),console.log(o.gray("👉 更多操作:"),o.blueBright(m),o.blueBright(u),o.blueBright(b)),"dev"!==i&&s.writeSync(i),console.log()}))}!function(){let e="",r={},a=0,n=1;const s=process.argv.splice(2);if(s[0]){let e=!1;Object.keys(f).map(((o,t)=>{o===s[0]&&(e=!0,a=t)})),e||console.log(o.gray("👻 没找到"),o.yellow(`{${s[0]}}`),o.gray("这个项目, 请从下方选择打包项目⬇️"))}"dev"===s[1]&&(n=0),t.prompt([{type:"rawlist",name:"projectName",message:"打包项目",default:a,choices:Object.keys(f).map((e=>({key:e,name:f[e].label,value:e})))},{type:"rawlist",name:"versionName",message:"打包版本",default:n,choices:[{name:"测试环境: dev",value:"dev"},i(),"自定义"]}]).then((a=>{r=f[a.projectName];const n=a.versionName;if("自定义"!==n)return e=n,void g(r,e);t.prompt([{type:"input",name:"inputVersion",message:"请输入版本号(如: 1.0.xx.xxxx)",validate:e=>4===e.split(".").length||o.red("🚫 版本号格式不正确, 正确格式为: x.x.xx.xxxx")}]).then((o=>{const{inputVersion:t}=o;e=t,g(r,e)}))}))}();
